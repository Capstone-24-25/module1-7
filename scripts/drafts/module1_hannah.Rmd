---
title: "module 1"
author: "Hannah Kim"
date: "2024-10-29"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir="C:/Users/hanna/OneDrive/Documents/pstat197/GitHub/module1-7")
```

```{r, message = F}
# Load in libraries
library(tidyverse)
library(tidymodels)
library(modelr)
library(rsample)
library(yardstick)
library(randomForest)
library(infer)
library(glmnet)
library(ggplot2)

load("data\\biomarker-clean.RData")
```

## -- LASSO Regression
```{r}
set.seed(102024)

biomarker <- biomarker_clean %>%
  select(-ados) %>%
  mutate(class = as.numeric(group == 'ASD'))

# Partitions 
biomarker_split <- biomarker %>%
  initial_split(prop = 0.8)

bio_train <- training(biomarker_split)
bio_test <- testing(biomarker_split)

predictors <- training(biomarker_split) %>%
  select(-c(group, class)) %>%
  as.matrix()

response <- training(biomarker_split) %>%
  pull(class)

# Selecting optimal lambda
cv_out <- cv.glmnet(predictors, 
                    response, 
                    family = 'binomial',
                    nfolds = 10, 
                    alpha = 1)
cv_out_df <- tidy(cv_out)

best_lambda <- cv_out_df %>%
  arrange(lambda) %>%
  filter(nzero > 7) %>%
  slice(1) %>%
  pull(lambda)

lasso_model <- glmnet(predictors, 
                      response,
                      family = 'binomial', 
                      alpha = 1, 
                      lambda = best_lambda)

lasso_coefs <- coef(lasso_model)
lasso_coefs_df <- as.data.frame(as.matrix(lasso_coefs)) %>%
  filter(s0 != 0)

lasso_proteins <- lasso_coefs_df %>%
  mutate(proteins = rownames(lasso_coefs_df)) %>%
  filter(rownames(lasso_coefs_df) != 'intercept') %>%
  slice_head(n = 10) %>%
  pull(proteins)
```

## -- Logistic Regression
```{r}
log_train <- training(biomarker_split) %>%
  select(group, any_of(lasso_proteins)) %>%
  mutate(class = (group == 'ASD')) %>%
  select(-group)

log_test <- testing(biomarker_split) %>%
  select(group, any_of(lasso_proteins)) %>%
  mutate(class = (group == 'ASD')) %>%
  select(-group)


log_fit <- glm(class ~ ., 
               data = biomarker, 
               family = 'binomial')
class_metric <- metric_set(sensitivity, 
                           specificity, 
                           accuracy, 
                           roc_auc)

log_test %>%
  add_predictions(fit, type = 'response') %>%
  mutate(est = as.factor(pred > 0.5), tr_c = as.factor(class)) %>%
  class_metric(estimate = est, 
               truth = tr_c, pred, 
               event_level = 'second')

```


